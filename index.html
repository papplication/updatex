<html>
  <body>
  	<h1>Update x</h1>
    <input type='button' onclick="connect()" value='connect'/>
    <input type='button' onclick="readwrite()" value='read/write'/>
    <div id="device_info"></div>
    <script>
    function log(result) {
  		let decoder = new TextDecoder();
  		console.log('Received: ' + decoder.decode(result.data));
	}
      var device;
      function connect() {  
		navigator.usb.requestDevice({ filters: [] })
		.then(selectedDevice => {
		   device = selectedDevice;
		   	console.log(device);
		   	var element = document.querySelector("#device_info");
			element.innerText = "[CONNECTED] deviceuctName: " + device.deviceuctName + " manufacturerName: " + device.manufacturerName + " serialNumber: " + device.serialNumber;
		   return device.open();
		 });
      }
      async function readwrite() {
      	await device.open();
		if (device.configuration === null)
  			await device.selectConfiguration(device.configurations[0].configurationValue);
		await device.claimInterface(device.configuration.interfaces[0].interfaceNumber);

		await device.controlTransferOut({
		    requestType: 'vendor',
		    recipient: 'interface',
		    request: 0x01,  // vendor-specific request: enable channels
		    value: 0x0013,  // 0b00010011 (channels 1, 2 and 5)
	    	index: 0x0001   // Interface 1 is the recipient
		});

		while (true) {
		  let result = await data.transferIn(1, 6);

		  if (result.data && result.data.byteLength === 6) {
		    console.log('Channel 1: ' + result.data.getUint16(0));
		    console.log('Channel 2: ' + result.data.getUint16(2));
		    console.log('Channel 5: ' + result.data.getUint16(4));
		  }

		  if (result.status === 'stall') {
		    console.warn('Endpoint stalled. Clearing.');
		    await device.clearHalt(1);
		  }
		}

		/*
      	return device.open().then(() => {
	      return device.reset();
	    }).then(() => {
	      return device.selectConfiguration(device.configurations[0].configurationValue);
	    }).then(() => {
	      console.log(device);
	      return device.claimInterface(device.configuration.interfaces[0].interfaceNumber);
	    }).then(() => {
	      console.log("will transfer initialize");
	      return device.transferOut(1, new Uint8Array([63, 35, 35, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
	  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]))
	    }).then(() => {
	      return device.transferIn(1, 64).then(log);
	    }).then(() => {
	      return device.transferIn(1, 64).then(log);
	    }).then(() => {
	      return device.transferIn(1, 64).then(log);
	    }).then(() => {
	      return device.transferIn(1, 64).then(log);
	    }).then(() => {
	      return device.transferIn(1, 64).then(log);
	    }).then(() => {
	      return device.transferIn(1, 64).then(log);
	    }).then(() => {
	      return device.transferIn(1, 64).then(log);
	    }).then(() => {
	      return device.transferIn(1, 64).then(log);
	    }).then(() => {
	      return device.transferIn(1, 64).then(log);
	    }).then(() => {
	      return device.releaseInterface(2);
	    }).then(() => {
	      return device.reset();
	    }).then(() => {
	      console.log(device);
	    }).catch((e) => {
	      console.error(e);
	    });
		*/
      }
    </script>
  </body>
</html>